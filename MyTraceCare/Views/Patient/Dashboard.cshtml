@model MyTraceCare.Models.HeatmapData

@{
    Layout = "~/Views/Patient/_PatientLayout.cshtml";
    ViewData["Title"] = "Patient Dashboard";

    var dates = ViewBag.AvailableDates as List<DateTime> ?? new();
    var selectedDate = (DateTime?)ViewBag.SelectedDate;
    int rangeMinutes = ViewBag.RangeMinutes ?? 60;
    string frameWarning = ViewBag.FrameWarning ?? "";
    string peakHistoryJson = ViewBag.PeakHistoryJson ?? "[]";
    string alertFramesJson = ViewBag.AlertFramesJson ?? "[]";
}

<div class="container mt-4">
    <h2 class="mb-4">Patient Dashboard</h2>

    <!-- DATE SELECT -->
    <form asp-action="Index" method="get" class="mb-3">
        <label class="fw-semibold me-2">Select a Date</label>
        <select name="date" class="form-select d-inline-block w-auto"
                onchange="this.form.submit()">
            @foreach (var d in dates)
            {
                <option value="@d.ToString("yyyy-MM-dd")"
                        selected="@(selectedDate?.Date == d.Date)">
                    @d.ToString("dd MMM yyyy")
                </option>
            }
        </select>

        <input type="hidden" name="frame" value="@Model.FrameIndex" />
        <input type="hidden" name="rangeMinutes" value="@rangeMinutes" />
    </form>

    <!-- DATA WARNING -->
    @if (!string.IsNullOrEmpty(frameWarning))
    {
        <div class="alert alert-warning mb-3">@frameWarning</div>
    }

    <!-- CONTROLS -->
    <form id="frameForm" asp-action="Index" method="get" class="mb-4">
        <input type="hidden" name="date" value="@Model.Date.ToString("yyyy-MM-dd")" />
        <input type="hidden" id="hiddenFrame" name="frame" value="@Model.FrameIndex" />
        <input type="hidden" id="hiddenRange" name="rangeMinutes" value="@rangeMinutes" />

        <div class="row align-items-end gy-2">
            <div class="col-lg-6">
                <label class="fw-semibold">Time frame</label>
                <input type="range"
                       class="form-range"
                       id="frameSlider"
                       min="0"
                       max="@(Model.TotalFrames - 1)"
                       value="@Model.FrameIndex" />
                Frame <span id="frameLabel">@Model.FrameIndex</span> / @(Model.TotalFrames - 1)
            </div>

            <div class="col-lg-2">
                <label class="fw-semibold">Window</label>
                <select id="rangeSelect" class="form-select">
                    @foreach (var v in new[] { 5, 10, 15, 30, 60, 120, 1440 })
                    {
                        <option value="@v" selected="@(v == rangeMinutes)">
                            @(v < 60 ? $"{v} min" : v == 1440 ? "24 hours" : $"{v / 60} hour")
                        </option>
                    }
                </select>
            </div>

            <div class="col-lg-2">
                <label class="fw-semibold">Speed</label>
                <select id="speedSelect" class="form-select">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="2">2x</option>
                </select>
            </div>

            <div class="col-lg-2 d-flex gap-2">
                <button type="button" id="btnPlay" class="btn btn-dark btn-sm">Play</button>
                <button type="button" id="btnPause" class="btn btn-outline-secondary btn-sm">Pause</button>
            </div>
        </div>
    </form>

    <!-- METRICS -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white p-3">
                <div class="small">Peak Pressure Index</div>
                <h3 id="ppiValue">@Model.PeakPressureIndex.ToString("0") kPa</h3>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3">
                <div class="small">Contact Area</div>
                <h3 id="contactValue">@Model.ContactAreaPercent.ToString("0.0")%</h3>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3">
                <div class="small">Risk Level</div>
                <h3 id="riskValue">@Model.RiskLevel</h3>
                <small>Max sensor: <span id="peakValue">@Model.PeakPressure</span> kPa</small>
            </div>
        </div>
    </div>

    <!-- HEATMAP + GRAPH -->
    <div class="row">
        <div class="col-12 col-lg-6 mb-4">
            <h4>Heatmap</h4>
            <div class="heatmap-grid">
                @for (int r = 0; r < 32; r++)
                {
                    for (int c = 0; c < 32; c++)
                    {
                        <div class="cell" id="cell-@r-@c"
                             style="background-color:@ColorScale(Model.Matrix[r, c])"></div>
                    }
                }
            </div>
        </div>

        <div class="col-12 col-lg-6 mb-4">
            <h4>Peak Pressure Index over time</h4>
            <div class="chart-wrapper">
                <canvas id="peakChart"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(32, 12px);
        gap: 1px;
    }

    .cell {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function colorScale(v) {
        if (v < 5) return "#e8f6ff";
        if (v < 15) return "#9bd2ff";
        if (v < 30) return "#ffbf80";
        return "#ff5c5c";
    }

    (() => {
        const slider = document.getElementById("frameSlider");
        const frameLabel = document.getElementById("frameLabel");
        const playBtn = document.getElementById("btnPlay");
        const pauseBtn = document.getElementById("btnPause");
        const speedSelect = document.getElementById("speedSelect");
        const rangeSelect = document.getElementById("rangeSelect");

        const ppiValue = document.getElementById("ppiValue");
        const contactValue = document.getElementById("contactValue");
        const riskValue = document.getElementById("riskValue");
        const peakValue = document.getElementById("peakValue");

        const selectedDate = "@Model.Date.ToString("yyyy-MM-dd")";
        const peakHistory = @Html.Raw(peakHistoryJson);
        const alertFrames = @Html.Raw(alertFramesJson);

        let chart;
        let playing = false;
        let lastTick = null;

        function buildChart() {
            if (chart) chart.destroy();

            chart = new Chart(document.getElementById("peakChart"), {
                type: "line",
                data: {
                    labels: peakHistory.map((_, i) => i),
                    datasets: [
                        {
                            data: peakHistory,
                            borderColor: "#2563eb",
                            tension: 0.25,
                            pointRadius: 0
                        },
                        {
                            type: "scatter",
                            data: alertFrames.map(f => ({ x: f, y: peakHistory[f] })),
                            backgroundColor: "red",
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: "Frame (seconds)" } },
                        y: { title: { display: true, text: "PPI (kPa)" } }
                    }
                }
            });
        }

        buildChart();

        async function loadFrame(frame) {
            const range = rangeSelect.value;
            const url = `/PatientDashboard/GetFrame?date=${selectedDate}&frame=${frame}&rangeMinutes=${range}`;
            const r = await fetch(url);
            if (!r.ok) return;
            const d = await r.json();
            if (!d.success) return;

            slider.value = d.frameIndex;
            frameLabel.innerText = d.frameIndex;

            ppiValue.innerText = `${d.peakPressureIndex.toFixed(0)} kPa`;
            contactValue.innerText = `${d.contactAreaPercent.toFixed(1)}%`;
            riskValue.innerText = d.riskLevel;
            peakValue.innerText = d.peakPressure.toFixed(0);

            let i = 0;
            for (let r = 0; r < 32; r++)
                for (let c = 0; c < 32; c++)
                    document.getElementById(`cell-${r}-${c}`)
                        .style.backgroundColor = colorScale(d.matrix[i++]);
        }

           function playLoop(timestamp) {
        if (!playing) return;

        if (!lastTick) lastTick = timestamp;

        const speed = parseFloat(speedSelect.value);
        if (speed <= 0) return;

        const elapsedMs = timestamp - lastTick;
        const framesToAdvance = Math.floor((elapsedMs / 1000) * speed);

        if (framesToAdvance > 0) {
            let next = parseInt(slider.value) + framesToAdvance;

            if (next >= slider.max) {
                next = slider.max;
                playing = false;
            }

            loadFrame(next);
            lastTick = timestamp;
        }

        requestAnimationFrame(playLoop);
    }


        playBtn.onclick = () => {
            if (playing) return;
            playing = true;
            lastTick = null;
            requestAnimationFrame(playLoop);
        };

        pauseBtn.onclick = () => playing = false;

        slider.oninput = () => frameLabel.innerText = slider.value;
        slider.onchange = () => loadFrame(+slider.value);

        speedSelect.onchange = () => {
            if (playing) {
                playing = false;
                playBtn.click();
            }
        };

        rangeSelect.onchange = () => {
            document.getElementById("hiddenRange").value = rangeSelect.value;
            document.getElementById("hiddenFrame").value = 0;
            document.getElementById("frameForm").submit();
        };
    })();
</script>

@functions {
    string ColorScale(double v)
    {
        if (v < 5) return "#e8f6ff";
        if (v < 15) return "#9bd2ff";
        if (v < 30) return "#ffbf80";
        return "#ff5c5c";
    }
}
